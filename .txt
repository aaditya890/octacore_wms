
Octacore@wms00


sb inward/outwards me form validation 
pagination bcha hai invenoty or indents me 
or bill invoice wla bhi bcha hai 
agr indents me add kre to invenoty me add ho item




export class GatepassListComponent {
   private svc = inject(GatepassService);
  private toast = inject(NotificationService);
  private auth = inject(AuthService);

  rows:any[] = [];
  isLoading = true;

  search = '';
  pass_type:'all'|'inward'|'outward'|'returnable'|'non-returnable'='all';
  status:'all'|'pending'|'approved'|'rejected'|'completed'='all';

  selected:any=null; reason=''; user:any; isAdmin=false;

  async ngOnInit() {
    this.user = this.auth.currentUser();
    this.isAdmin = (this.user?.role || '').toLowerCase() === 'admin';
    await this.load();
  }

  async load() {
    this.isLoading = true;
    try {
      const { rows } = await this.svc.list({
        search_term: this.search, pass_type: this.pass_type, status: this.status,
        role: this.user?.role, userId: this.user?.id
      });
      this.rows = rows;
    } catch(e){ this.toast.error('Failed to load'); }
    finally { this.isLoading = false; }
  }

  async open(id:string) {
    try {
      this.isLoading = true;
      this.selected = await this.svc.getWithItems(id);
    } catch(e){ this.toast.error('Failed to open'); }
    finally { this.isLoading = false; }
  }

  async approve() {
    try { await this.svc.approve(this.selected.id, this.user?.id); this.toast.success('Approved'); this.selected.status='approved'; await this.load(); }
    catch(e){ this.toast.error('Error'); }
  }

  async reject() {
    if(!this.reason.trim()) return this.toast.error('Reason required');
    try { await this.svc.reject(this.selected.id, this.reason); this.toast.success('Rejected'); this.selected.status='rejected'; this.reason=''; await this.load(); }
    catch(e){ this.toast.error('Error'); }
  }

  async complete() {
    try { await this.svc.complete(this.selected.id); this.toast.success('Completed'); this.selected.status='completed'; await this.load(); }
    catch(e){ this.toast.error('Error'); }
  }

  async updateReturned(it:any) {
    try { await this.svc.updateReturnQty(it.id, Number(it.returned_quantity||0)); }
    catch(e){ this.toast.error('Update failed'); }
  }

  async remove(id:string) {
    if (!confirm('Delete this gate pass?')) return;
    try { await this.svc.delete(id); this.toast.success('Deleted'); await this.load(); }
    catch(e){ this.toast.error('Delete failed'); }
  }
}





<div class="min-h-screen bg-gray-50 px-8 py-10">
  <div class="max-w-6xl mx-auto space-y-6">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Gate Passes</h1>
        <p class="text-gray-600 text-sm">Manage entry/exit permissions</p>
      </div>
      <div class="flex gap-2">
        <a routerLink="/gate-pass/verify" class="px-3 py-2 border border-gray-700 rounded-md">Verify</a>
        <a routerLink="/gate-pass/create" class="bg-black text-white px-4 py-2 rounded-md">+ Create</a>
      </div>
    </div>

    <!-- filters -->
    <div class="flex flex-wrap gap-2 items-center">
      <input [(ngModel)]="search" (keyup.enter)="load()" placeholder="Search pass number…" class="border border-gray-400 rounded-md p-2">
      <select [(ngModel)]="pass_type" (change)="load()" class="border border-gray-400 rounded-md p-2">
        <option value="all">All Types</option>
        <option>inward</option><option>outward</option>
        <option>returnable</option><option>non-returnable</option>
      </select>
      <select [(ngModel)]="status" (change)="load()" class="border border-gray-400 rounded-md p-2">
        <option value="all">All Status</option>
        <option>pending</option><option>approved</option>
        <option>rejected</option><option>completed</option>
      </select>
    </div>

    <div *ngIf="isLoading" class="text-gray-600">Loading…</div>
    <div *ngIf="!isLoading && rows.length===0" class="text-gray-600">No passes.</div>

    <div *ngIf="!isLoading && rows.length>0" class="bg-white border border-gray-300 rounded-xl overflow-hidden">
      <table class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="text-left p-3">#</th>
            <th class="text-left p-3">Pass No</th>
            <th class="text-left p-3">Type</th>
            <th class="text-left p-3">Party</th>
            <th class="text-left p-3">Purpose</th>
            <th class="text-left p-3">Status</th>
            <th class="text-center p-3">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let gp of rows; let i=index" class="border-t">
            <td class="p-3">{{ i+1 }}</td>
            <td class="p-3 font-semibold">{{ gp.pass_number }}</td>
            <td class="p-3 capitalize">{{ gp.pass_type }}</td>
            <td class="p-3">{{ gp.party_name }}</td>
            <td class="p-3 truncate max-w-[260px]">{{ gp.purpose }}</td>
            <td class="p-3 capitalize">
              <span class="px-2 py-0.5 text-xs rounded-full border"
                [ngClass]="{
                  'border-gray-400 text-gray-700 bg-gray-100': gp.status==='pending',
                  'border-green-500 text-green-700 bg-green-100': gp.status==='approved',
                  'border-red-500 text-red-700 bg-red-100': gp.status==='rejected',
                  'border-blue-500 text-blue-700 bg-blue-100': gp.status==='completed'
                }">{{ gp.status }}</span>
            </td>
            <td class="p-3 text-center">
              <div class="flex gap-2 justify-center">
                <button (click)="open(gp.id)" class="px-3 py-1 border rounded-md">View</button>
                <button *ngIf="isAdmin" (click)="remove(gp.id)" class="px-3 py-1 border rounded-md text-red-600">Delete</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- modal -->
    <div *ngIf="selected" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white border border-gray-300 rounded-xl w-full max-w-3xl p-6 relative">
        <button (click)="selected=null" class="absolute top-3 right-3 text-xl">×</button>
        <h2 class="text-xl font-semibold mb-4">Pass Details</h2>

        <div class="grid grid-cols-2 gap-3 text-sm">
          <div><b>No:</b> {{selected.pass_number}}</div>
          <div class="capitalize"><b>Type:</b> {{selected.pass_type}}</div>
          <div><b>Party:</b> {{selected.party_name}}</div>
          <div><b>Contact:</b> {{selected.party_contact || '—'}}</div>
          <div><b>Vehicle:</b> {{selected.vehicle_number || '—'}}</div>
          <div><b>Driver:</b> {{selected.driver_name || '—'}} ({{selected.driver_contact || '—'}})</div>
          <div><b>Purpose:</b> {{selected.purpose}}</div>
          <div><b>Status:</b> {{selected.status}}</div>
          <div *ngIf="selected.expected_return_date"><b>Expected Return:</b> {{selected.expected_return_date | date}}</div>
          <div *ngIf="selected.rejection_reason" class="col-span-2 text-red-700 bg-red-50 border border-red-200 rounded p-2">
            <b>Rejection Reason:</b> {{selected.rejection_reason}}
          </div>
        </div>

        <h3 class="font-semibold mt-5 mb-2">Items</h3>
        <table class="w-full text-sm border">
          <thead class="bg-gray-100">
            <tr>
              <th class="p-2 text-left">Item</th>
              <th class="p-2 text-left">Desc</th>
              <th class="p-2">Qty</th>
              <th class="p-2">Unit</th>
              <th class="p-2" *ngIf="selected.pass_type==='returnable'">Returned</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of selected.items" class="border-t">
              <td class="p-2">{{it.item_name}}</td>
              <td class="p-2">{{it.description}}</td>
              <td class="p-2 text-center">{{it.quantity}}</td>
              <td class="p-2 text-center">{{it.unit}}</td>
              <td class="p-2 text-center" *ngIf="selected.pass_type==='returnable'">
                <input type="number" min="0" [max]="it.quantity" [(ngModel)]="it.returned_quantity"
                  (change)="updateReturned(it)" class="w-20 border border-gray-300 rounded p-1 text-center">
              </td>
            </tr>
          </tbody>
        </table>

        <!-- actions -->
        <div class="flex flex-wrap gap-3 mt-5" *ngIf="isAdmin">
          <ng-container [ngSwitch]="selected.status">
            <div *ngSwitchCase="'pending'" class="flex gap-2 items-center">
              <button (click)="approve()" class="px-3 py-1 border rounded-md">Approve</button>
              <input [(ngModel)]="reason" placeholder="Rejection reason" class="border rounded-md p-1">
              <button (click)="reject()" class="px-3 py-1 border rounded-md text-red-600">Reject</button>
            </div>
            <button *ngSwitchCase="'approved'" (click)="complete()" class="px-3 py-1 border rounded-md">Mark Completed</button>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

